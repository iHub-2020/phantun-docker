# ------------------------------------------------------------------------------
# File: docker-compose.yml
# Description: Phantun Docker Deployment
# Author: iHub-2020
# Date: 2026-02-01
# Version: 1.1.0
# ------------------------------------------------------------------------------

version: "3"
services:
  phantun:
    # ================= 镜像配置 =================
    # 使用 GitHub Container Registry 镜像
    image: ghcr.io/ihub-2020/phantun-docker:latest

    # 如果需要本地构建，注释上面的 image，取消下面的注释
    # build:
    #   context: .
    #   dockerfile: Dockerfile

    container_name: phantun-tcp-tunnel
    hostname: phantun

    # --------------------------------------------------------------------------
    # Network Configuration
    # Host networking is recommended for Phantun to simplify iptables management
    # and achieve maximum TUN performance.
    # --------------------------------------------------------------------------
    network_mode: "host"
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun

    # --------------------------------------------------------------------------
    # Persistence & Configuration
    # Use environment variables to override defaults.
    # PHANTUN_CONFIG_DIR defaults to /opt/phantun/
    # --------------------------------------------------------------------------
    volumes:
      - ${PHANTUN_CONFIG_DIR:-/opt/phantun/}:/etc/phantun

    restart: unless-stopped

    environment:
      - PHANTUN_CONFIG=/etc/phantun/config.json
      # Login Credentials (Default: admin/admin)
      - PHANTUN_USER=${PHANTUN_USER:-admin}
      - PHANTUN_PASSWORD=${PHANTUN_PASSWORD:-admin}

    # --------------------------------------------------------------------------
    # Healthcheck
    # Curler to internal API to verify service is up.
    # --------------------------------------------------------------------------
    healthcheck:
      test: [ "CMD", "curl", "-f", "-k", "http://localhost:8080/api/status" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s

# ------------------------------------------------------------------------------
# Usage Instructions:
# 1. Start: docker-compose up -d
# 2. Enter Container: docker exec -it phantun sh
# 3. View Logs: docker logs -f phantun
# ------------------------------------------------------------------------------
